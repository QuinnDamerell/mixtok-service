<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MixTok - ClipMine Explorer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>
    
    </script>
    <script>
        let globalRequestId = 0;
        let globalRefreshId = 0;

        var updatingStrings = [
            "Accessing the hive mind...",
            "Asking the mixer gods...",
            "Unearthing more clips...",
            "Accessing the clip matrix...",
            "Asking Quinn to find more clips..."
        ]

        function RefreshResults()
        {
            // To prevent us from calling the API every time a letter is typed,
            // set a delay and only make the request if nothing else comes in.
            globalRefreshId++;
            var localRefreshId = globalRefreshId;
            setTimeout(function(){
                if(globalRefreshId !== localRefreshId) return;
                RefreshResultsDoIt();
            }, 100);
        }

        function RefreshResultsDoIt() 
        {
            var urlArgs = "?";
            var sortType = 0;
            var sortValue = $("#sortType").children("option:selected").val();
            if( sortValue !== "viewCount")
            {
                sortType = 1;
            }
            urlArgs += `sortType=${sortType}`

            var fromTime = $("#fromTime").val()
            if(fromTime.length !== 0)
            {
                urlArgs += `&fromTime=${fromTime}`
            }

            var toTime = $("#toTime").val()
            if(toTime.length !== 0)
            {
                urlArgs += `&toTime=${toTime}`
            }

            var language = $("#language").val()
            if(language.length !== 0)
            {
                urlArgs += `&language=${language}`
            }

            var gameTitle = $("#gameTitle").val()
            if(gameTitle.length !== 0)
            {
                urlArgs += `&gameTitle=${gameTitle}`
            }

            var channelName = $("#channelName").val()
            if(channelName.length !== 0)
            {
                urlArgs += `&channelName=${channelName}`
            }

            var minViewCount = $("#minViewCount").val()
            if(minViewCount.length !== 0)
            {
                urlArgs += `&ViewCountMin=${minViewCount}`
            }

            var isLiveValue = $("#isLive").children("option:selected").val();
            if( isLiveValue === "live")
            {
                urlArgs += `&isLive=true`
            }
            else if(isLiveValue === "notLive")
            {
                urlArgs += `&isLive=false`
            }

            var partneredValue = $("#partnered").children("option:selected").val();
            if( partneredValue === "partnered")
            {
                urlArgs += `&partnered=true`
            }
            else if(partneredValue === "notPartnered")
            {
                urlArgs += `&partnered=false`
            }       

            // Increment the global request id and then take it locally.
            globalRequestId++;     
            var localRequestId = globalRequestId;

            // Set a timer to clear the UI if the request is talking a long time.
            var isUpdated = false;
            setTimeout(function() {
                // Make sure we don't already have results
                if(isUpdated) return;
                
                // Ensure our request is still the newest request.
                if(globalRequestId !== localRequestId) return;

                // Show some text to say we are updating.
                $("#resultsPanel").html(""+updatingStrings[Math.floor(Math.random() * updatingStrings.length)]);
            }, 500);

            $.get(`/api/v1/ClipMine${urlArgs}`, 
                function(data){
                    isUpdated = true;
                    // Ensure our request is still the newest request.
                    if(globalRequestId !== localRequestId) return;

                    // Push the results
                    $("#resultsPanel").html("");
                    if(data.length === 0)
                    {
                        $("#resultsPanel").html("No Results!");
                    }
                    else
                    {                        
                        for (var i in data) 
                        {
                            var clip = data[i]

                            var thumbUrl;
                            for(var c in clip.contentLocators)
                            {
                                if(clip.contentLocators[c].locatorType === "Thumbnail_Small")
                                {
                                    thumbUrl = clip.contentLocators[c].uri;
                                }
                            }

                            $("#resultsPanel").append(
                            `
                            <div id="clipContainer" class="${i & 0 === 0 ? "darken" : "normal"}">
                                <div id="clipThumbHolder">
                                    <img id="clipThumb" src="${thumbUrl}" onclick="playClip('${clip.clipUrl}')" />
                                </div>
                                <div id="clipDetails">
                                    <strong>Title: </strong>${clip.title}<br />
                                    <strong>Channel: </strong>${clip.channel.token}<br />
                                    <strong>Views: </strong>${clip.viewCount}<br />
                                    <strong>Game:  </strong>${clip.gameTitle}<br />
                                    <strong>Live Now: </strong>${clip.channel.online}<br />
                                    <strong>Created: </strong>${Date.parse(clip.uploadDate).toLocaleString("en-us")}<br />
                                    <strong>Url: </strong><a target="_blank" href="${clip.shareableUrl}">${clip.shareableUrl}</a><br />                                    
                                </div>
                            </div>
                            `
                        );
                    }
                }
            })
            .fail(function(data, textStatus, xhr) {

                isUpdated = true;
                
                // Ensure our request is still the newest request.
                if(globalRequestId !== localRequestId) return;

                // Report the error.
                $("#resultsPanel").html(`<strong>${xhr}</strong><br/>${data.responseText}`);
            });       
        }

        function UpdateStats()
        {
            $.get(`/api/v1/stats`, function(data, status){
                $("#stats").html(`<strong>${Number(data.indexedClips).toLocaleString('en')} Clips Indexed</strong> - ${Number(data.channelsWithClips).toLocaleString('en')} Channels`);
                $("#updateTime").html(`Updated ${data.lastUpdate} ago`);
                // $("#clipsLast24Hr").html(data.clipsCreatedInLastDay);
                // $("#channelsWithClips").html(data.channelsWithClips);
                // $("#liveChannelsWithClips").html(data.liveChannelsWithClips);
                // $("#lastUpdated").html(data.lastUpdate);
                // $("#lastUpdateDuration").html(data.lastUpdateDuration);
            });
        }

        $(function() {
            $("#sortType").change(function() {
                RefreshResults();
            });
            $('#fromTime').on('input',function(e){
                RefreshResults();
            });
            $('#toTime').on('input',function(e){
                RefreshResults();
            });
            $('#language').on('input',function(e){
                RefreshResults();
            });
            $('#gameTitle').on('input',function(e){
                RefreshResults();
            });
            $('#channelName').on('input',function(e){
                RefreshResults();
            });
            $('#minViewCount').on('input',function(e){
                RefreshResults();
            });
            $("#isLive").change(function() {
                RefreshResults();
            });
            $("#partnered").change(function() {
                RefreshResults();
            });

            setInterval(UpdateStats, 2000); 
            
            RefreshResults(); 
            UpdateStats();           
        });    

        function playClip(url)
        {
            var popup = document.getElementById("myPopup");
            popup.classList.toggle("show");
        } 
    </script>
    <style>
         /* The sidebar menu */
        .sidenav {
            height: 100%; /* Full-height: remove this if you want "auto" height */
            width: 270px; /* Set the width of the sidebar */
            position: fixed; /* Fixed Sidebar (stay in place on scroll) */
            z-index: 1; /* Stay on top */
            top: 0; /* Stay at the top */
            left: 0;
            background-color: #efefef;
            text-decoration-color: #a9a9a9;
            overflow-x: hidden; /* Disable horizontal scroll */
            padding-top: 10px;
            padding-left: 10px;
        }
        /* The navigation menu links */
        .sidenav a {
            padding: 6px 8px 6px 16px;
            text-decoration: none;
            font-size: 25px;
            color: #efefef;
            display: block;
        }
        /* When you mouse over the navigation links, change their color */
        .sidenav a:hover {
            color: #f1f1f1;
        }
        /* Style page content */
        .main {
            margin-left: 270px; /* Same as the width of the sidebar */
            padding: 0px 10px;
        }
        #title {
            font-size: 28px;
        }
        #apiDocs {
            font-size: 15px;
        }
        #filterHeader {
            padding-top: 20px;
            font-size: 20px;
        }
        .filter {
            width: 230px;
            margin-top: 5px;
        }
        /* On smaller screens, where height is less than 450px, change the style of the sidebar (less padding and a smaller font size) */
        @media screen and (max-height: 450px) {
            .sidenav {padding-top: 15px;}
            .sidenav a {font-size: 18px;}
        } 

        .darken {
            background-color: #caebf2
        }
        #clipContainer {
            height: 150px;
            width: 100%;
            display: flex;
            padding: 10px;
        }
        #clipThumbHolder {
            width: 20%;
        }

        #clipThumb {
            max-width:100%;
            max-height:100%;
        }
        #clipDetails {
            width: 50%;
        }
        #rightThing {
        width: 25%;
        background-color: yellow;
        }

        /* Popup container - can be anything you want */
        .popup {
        position: relative;
        display: inline-block;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        }

        /* The actual popup */
        .popup .popuptext {
        visibility: hidden;
        width: 160px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px 0;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -80px;
        }

        /* Popup arrow */
        .popup .popuptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
        }

        /* Toggle this class - hide and show the popup */
        .popup .show {
        visibility: visible;
        -webkit-animation: fadeIn 1s;
        animation: fadeIn 1s;
        }

        /* Add animation (fade in the popup) */
        @-webkit-keyframes fadeIn {
        from {opacity: 0;} 
        to {opacity: 1;}
        }

        @keyframes fadeIn {
        from {opacity: 0;}
        to {opacity:1 ;}
        }
    </style>
    </head>
    <body>
         <!-- Side navigation -->
        <div class="sidenav">
            <div id="title">MixTok - ClipMine!</div>
            <div id="stats">0 Clips - 0 Channels</div>
            <div id="updateTime">Updated 0s ago</div>
            <div id="apiDocs">API Docs</div>
            <div id="filterHeader">Sort</div>
            <select class="filter" id="sortType">
                <option value="viewCount">View Count</option>
                <option value="MixTokRank">MixTok Rank</option>
            </select> 
            <div id="filterHeader">From Time</div>
            <input type="text" class="filter" id="fromTime" placeholder="1h, 3d, 15m..." />
            <div id="filterHeader">To Time</div>
            <input type="text" class="filter" id="toTime" placeholder="1h, 3d, 15m..." />
            <div id="filterHeader">Language</div>
            <input type="text" class="filter" id="language" placeholder="en, es..." /> 
            <div id="filterHeader">Game Title</div>
            <input type="text" class="filter" id="gameTitle" placeholder="League Of Legends, Fortnite..." />            
            <div id="filterHeader">Channel Name</div>
            <input type="text" class="filter" id="channelName" placeholder="Quinninator, Forest..." /> 
            <div id="filterHeader">Min Clip View Count</div>
            <input type="number" class="filter" id="minViewCount" placeholder="5, 10, 15..." />
            <div id="filterHeader">Is Live</div>
            <select class="filter" id="isLive">
                <option value="any">Any</option>
                <option value="live">Live</option>
                <option value="notLive">Not Live</option>
            </select> 
            <div id="filterHeader">Partnered</div>
            <select class="filter" id="partnered">
                <option value="any">Any</option>
                <option value="partnered">Partnered</option>
                <option value="notPartnered">Not Partnered</option>
            </select> 
        </div>
      
      <!-- Page content -->
      <div class="main">
        <span class="popuptext" id="myPopup">A Simple Popup!</span>
        <div id="resultsPanel"></div>
      </div> 
    </body>
</html>